---
title: "Data Import and Preparation"
author: "Eugene CHEONG Wei Herng"
date: "10/22/2020"
output:
  html_document:
    theme: spacelab
    highlight: tango
    toc: true
    toc_float: true
    toc_depth: 4
    code:folding: show
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Import Required Libraries

```{r}
packages = c('tidyverse', 'httr', 'jsonlite')
for (p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
    }
  library(p,character.only = T)
}
```

# Import Aspatial Data from Folder

```{r}
file_dir <- "data/aspatial/"
file_list <- c("acra-information-on-corporate-entities-a.csv",
               "acra-information-on-corporate-entities-b.csv",
               "acra-information-on-corporate-entities-c.csv",
               "acra-information-on-corporate-entities-d.csv",
               "acra-information-on-corporate-entities-e.csv",
               "acra-information-on-corporate-entities-f.csv",
               "acra-information-on-corporate-entities-g.csv",
               "acra-information-on-corporate-entities-h.csv",
               "acra-information-on-corporate-entities-i.csv",
               "acra-information-on-corporate-entities-j.csv",
               "acra-information-on-corporate-entities-k.csv",
               "acra-information-on-corporate-entities-l.csv",
               "acra-information-on-corporate-entities-m.csv",
               "acra-information-on-corporate-entities-n.csv",
               "acra-information-on-corporate-entities-o.csv",
               "acra-information-on-corporate-entities-others.csv",
               "acra-information-on-corporate-entities-p.csv",
               "acra-information-on-corporate-entities-q.csv",
               "acra-information-on-corporate-entities-r.csv",
               "acra-information-on-corporate-entities-s.csv",
               "acra-information-on-corporate-entities-t.csv",
               "acra-information-on-corporate-entities-u.csv",
               "acra-information-on-corporate-entities-v.csv",
               "acra-information-on-corporate-entities-w.csv",
               "acra-information-on-corporate-entities-x.csv",
               "acra-information-on-corporate-entities-y.csv",
               "acra-information-on-corporate-entities-z.csv")
```

```{r}
prep_data <- function(file_dir, file_list, start_year, end_year) {
  for (file in file_list) {
    biz_csv <- read_csv(paste0(file_dir, file),
                        col_types = cols(primary_ssic_code = "c")) %>%
      filter(entity_status_description %in% c("Live", "Live Company")) %>%
      mutate(registration_year = format(as.Date(uen_issue_date, format="%Y-%m-%d"),"%Y")) %>%
      filter(registration_year >= start_year & registration_year <= end_year) %>%
      mutate(`primary_ssic_code` = substr(primary_ssic_code, start = 1, stop = 2)) %>%
      select("uen",
         "registration_year",
         "primary_ssic_code",
         "postal_code")
    if (!exists("result_csv")) {
      result_csv <- data.frame(biz_csv)
    } else {
      result_csv <- bind_rows(result_csv, biz_csv)
      print(paste0(file, " has been successfully processed."))
    }
  }
  write_csv(result_csv, "data/aspatial/sg-corp-info.csv")
  print("Completed. Please see newly created .csv file for results.")
}
```

```{r}
prep_data(file_dir, file_list, 2017, 2019)
```

```{r}
corp_info <- read_csv("data/aspatial/sg-corp-info.csv")
baseURL <- "https://developers.onemap.sg/"
end_point <- "commonapi/search?"
param_search <- "searchVal="
other_param <- "&returnGeom=Y&getAddrDetails=N"
postal_code = "579722"
API_call <- paste0(baseURL, end_point, param_search, postal_code, other_param)
API_call
```

```{r}
req <- GET(API_call)
```

```{r}
json <- content(req, as = "text")
json_info <- fromJSON(json)
```

```{r}
json_info$results["X"]
```


```{r}
call_onemap <- function(postal_code) {
  corp_info <- read_csv("data/aspatial/sg-corp-info.csv")
  baseURL <- "https://developers.onemap.sg/"
  end_point <- "commonapi/search?"
  param_search <- "searchVal="
  other_param <- "&returnGeom=Y&getAddrDetails=N"
  req <- GET(paste0(baseURL, end_point, param_search, postal_code, other_param))
  json <- content(req, as = "text")
  json_info <- fromJSON(json)
  return (c(json_info$results["X"], json_info$results["Y"]))
}
```

```{r}
corp_info <- read_csv("data/aspatial/sg-corp-info.csv")
```

```{r}
length(unique(corp_info$postal_code))
```

```{r}
unique_postal_code <- as.data.frame(unique(corp_info$postal_code))
colnames(unique_postal_code)[colnames(unique_postal_code) == "unique(corp_info$postal_code)"] <- "postal_code"
```

```{r}
postal_code_geom <- unique_postal_code %>%
  mutate(X_coord = as.numeric(1.1), Y_coord = as.numeric(1.1))
```

```{r}
postal_code_geom <- read_csv("data/aspatial/postal_code_geom.csv")
```


```{r warning=FALSE, message=FALSE}
for (row_num in 20001:24217) {
  postal_code <- postal_code_geom[row_num,]["postal_code"]
  if (nchar(postal_code) == 5) {
    postal_code <- paste0("0", postal_code)
  }
  if (!(postal_code_geom[row_num,]["X_coord"] == as.numeric(1.1))) next
  else {
    Sys.sleep(0.8)
    tryCatch({coords <- call_onemap(postal_code)},
             error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
    if ("X" %in% names(coords)) {
      postal_code_geom[row_num, ]["X_coord"] <- as.numeric(coords[["X"]][1])
      postal_code_geom[row_num, ]["Y_coord"] <- as.numeric(coords[["Y"]][1])     
    }
    else {
      postal_code_geom[row_num, ]["X_coord"] <- NA
      postal_code_geom[row_num, ]["Y_coord"] <- NA
    }

  }
}
```

```{r}
NA == as.numeric(1.1)
```

```{r}
write_csv(postal_code_geom, "data/aspatial/postal_code_geom.csv")
```

<<<<<<< Updated upstream

# Clean SSIC file, title based primary ssic code, remove columns that are redundant

```{r}
ssic <- read.csv('data/aspatial/ssic2020-classification-structure.csv')
ssic <- ssic[-c(1:3),]
names(ssic) <- ssic[1,]
ssic <- ssic[-c(1),]
ssic <- ssic %>%
  filter((nchar(`SSIC 2020`) == 2))

ssic$`category` <- "A"

ssic$`category`[ssic$`SSIC 2020` %in% c('01','02','03')] <- "A"
ssic$`category`[ssic$`SSIC 2020` %in% c('08','09')] <- "B"
ssic$`category`[ssic$`SSIC 2020` %in% c('10','11','12','13','14','15','16','17','18','19','20','21','22','23','24','25','26','27','28','29','30','31','32')] <- "C"
ssic$`category`[ssic$`SSIC 2020` %in% c('35')] <- "D"
ssic$`category`[ssic$`SSIC 2020` %in% c('36','37','38')] <- "E"
ssic$`category`[ssic$`SSIC 2020` %in% c('41','42','43')] <- "F"
ssic$`category`[ssic$`SSIC 2020` %in% c('46','47')] <- "G"
ssic$`category`[ssic$`SSIC 2020` %in% c('49','50','51','52','53')] <- "H"
ssic$`category`[ssic$`SSIC 2020` %in% c('55','56')] <- "I"
ssic$`category`[ssic$`SSIC 2020` %in% c('58','59','60','61','62','63')] <- "J"
ssic$`category`[ssic$`SSIC 2020` %in% c('64','65','66')] <- "K"
ssic$`category`[ssic$`SSIC 2020` %in% c('68')] <- "L"
ssic$`category`[ssic$`SSIC 2020` %in% c('69','70','71','72','73','74','75')] <- "M"
ssic$`category`[ssic$`SSIC 2020` %in% c('77','78','79','80','81','82')] <- "N"
ssic$`category`[ssic$`SSIC 2020` %in% c('84')] <- "O"
ssic$`category`[ssic$`SSIC 2020` %in% c('85')] <- "P"
ssic$`category`[ssic$`SSIC 2020` %in% c('86','87','88')] <- "Q"
ssic$`category`[ssic$`SSIC 2020` %in% c('90','91','92','93')] <- "R"
ssic$`category`[ssic$`SSIC 2020` %in% c('94','95','96')] <- "S"
ssic$`category`[ssic$`SSIC 2020` %in% c('97')] <- "T"
ssic$`category`[ssic$`SSIC 2020` %in% c('99')] <- "U"
```

# Clean SSIC file, title based A to U

```{r}
ssic1 <- read.csv('data/aspatial/ssic2020-classification-structure.csv')
ssic1 <- ssic1[-c(1:3),]
names(ssic1) <- ssic1[1,]
ssic1 <- ssic1[-c(1),]
ssic1 <- ssic1 %>%
  filter((nchar(`SSIC 2020`) == 1))

```

# Join both ssic dataframe, title based on category

```{r}
ssic <- left_join(ssic,ssic1,by=c('category' = "SSIC 2020")) %>%
  select(-`SSIC 2020 Title.x`)
```

```{r}
names(ssic)[names(ssic) == 'SSIC 2020 Title.y'] <- 'primary_ssic_code'
write_csv(ssic, "data/aspatial/ssic2020.csv")
```


# Join corp_info with ssic categories and respective descriptions

```{r}
corp_info <- left_join(corp_info_sliced_ssic_code,ssic,by=c('primary_ssic_code' = "SSIC 2020"))
names(corp_info)[names(corp_info) == 'primary_ssic_code.y'] <- 'primary_ssic_category_description'
```


```{r}
# coords <- call_onemap("089057")
nchar("89057") == 5
nchar("089057") == 5
```

```{r warning=FALSE, message=FALSE}
for (row_num in 1:10000) {
  postal_code <- postal_code_geom[row_num,]["postal_code"]
  if (nchar(postal_code) == 5) {
    postal_code <- paste0("0", postal_code)
    Sys.sleep(0.8)
    tryCatch({coords <- call_onemap(postal_code)},
             error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
    if ("X" %in% names(coords)) {
      postal_code_geom[row_num, ]["X_coord"] <- as.numeric(coords[["X"]][1])
      postal_code_geom[row_num, ]["Y_coord"] <- as.numeric(coords[["Y"]][1])     
    }
    else {
      postal_code_geom[row_num, ]["X_coord"] <- NA
      postal_code_geom[row_num, ]["Y_coord"] <- NA
    }
  }
}
```

